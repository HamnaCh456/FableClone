@model MyMvcAuthProject.Models.Book

<div class="firecrawl-reviews-wrapper">
    <style>
        /* Firecrawl Design System - Scoped for Reviews */
        .firecrawl-reviews-wrapper {
            --fc-primary: #FA5D19;
            --fc-accent: #000000;
            --fc-bg: #F9F9F9;
            --fc-surface: #FFFFFF;
            --fc-text-primary: #262626;
            --fc-text-secondary: rgba(38, 38, 38, 0.4);
            --fc-border: rgba(0, 0, 0, 0.08);
            --fc-shadow-card: 0px 4px 6px -1px rgba(0, 0, 0, 0.1), 0px 2px 4px -1px rgba(0, 0, 0, 0.06);
            --fc-shadow-btn: 0px 1px 2px rgba(0, 0, 0, 0.05);
            --fc-shadow-btn-hover: 0 4px 12px rgba(250, 93, 25, 0.25);
            --fc-radius-card: 24px;
            --fc-radius-btn: 999px;
            --fc-radius-input: 8px;
            --fc-font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            
            font-family: var(--fc-font-family);
            color: var(--fc-text-primary);
        }

        /* Header Area */
        .reviews-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .reviews-title {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin: 0;
            color: var(--fc-accent);
        }

        /* Buttons */
        .btn-firecrawl {
            height: 40px;
            padding: 0 24px;
            border-radius: var(--fc-radius-btn);
            font-size: 14px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn-primary-fc {
            background-color: var(--fc-primary);
            color: white;
            box-shadow: var(--fc-shadow-btn);
        }
        .btn-primary-fc:hover {
            box-shadow: var(--fc-shadow-btn-hover);
            transform: translateY(-1px);
            color: white;
        }
        
        .btn-secondary-fc {
            background-color: var(--fc-accent);
            color: white;
            box-shadow: var(--fc-shadow-btn);
        }
        .btn-secondary-fc:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            color: white;
        }

        .btn-ghost-fc {
            background-color: transparent;
            color: var(--fc-text-primary);
            border: 1px solid var(--fc-border);
        }
        .btn-ghost-fc:hover {
            background-color: rgba(0,0,0,0.02);
        }

        /* Review Card */
        .review-card {
            background: var(--fc-surface);
            border-radius: var(--fc-radius-card);
            box-shadow: var(--fc-shadow-card);
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid var(--fc-border);
            transition: transform 0.2s ease;
        }
        .review-card:hover {
            transform: translateY(-2px);
        }

        .review-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .review-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--fc-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .review-meta {
            display: flex;
            flex-direction: column;
        }
        .review-author {
            font-weight: 600;
            font-size: 15px;
            color: var(--fc-text-primary);
        }
        .review-verified {
            font-size: 12px;
            color: var(--fc-text-secondary);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .review-stars {
            margin-bottom: 12px;
            color: var(--fc-primary);
            font-size: 14px;
        }

        .review-content {
            font-size: 15px;
            line-height: 1.6;
            color: var(--fc-text-primary);
            margin-bottom: 16px;
            white-space: pre-wrap;
        }

        /* Tags */
        .tag-pill {
            display: inline-block;
            background-color: rgba(250, 93, 25, 0.08);
            color: var(--fc-primary);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }

        /* Form Area */
        #addReviewFormSection {
            background: var(--fc-surface);
            padding: 32px;
            border-radius: var(--fc-radius-card);
            box-shadow: var(--fc-shadow-card);
            margin-bottom: 32px;
            border: 1px solid var(--fc-border);
            display: none; /* Initially hidden */
            animation: slideDown 0.3s ease-out;
        }

        @@keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-label-fc {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--fc-text-primary);
            font-size: 14px;
        }

        .form-control-fc {
            width: 100%;
            background: var(--fc-surface);
            border: 1px solid var(--fc-border);
            border-radius: var(--fc-radius-input);
            padding: 12px;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.2s;
            resize: vertical;
        }
        .form-control-fc:focus {
            outline: none;
            border-color: var(--fc-primary);
            box-shadow: 0 0 0 3px rgba(250, 93, 25, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: flex-end;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--fc-text-secondary);
        }
    </style>

    <div class="reviews-header">
        <h3 class="reviews-title">Reviews,</h3>
        @{
            var isAuthenticated = User.Identity?.IsAuthenticated ?? false;
            var currentUrl = Url.Action("Index", "Book", new { id = Model.BookId }) ?? Context.Request.Path;
            var loginUrl = "/Identity/Account/Login?ReturnUrl=" + System.Net.WebUtility.UrlEncode(Context.Request.Path + Context.Request.QueryString);
        }

        @if (isAuthenticated)
        {
             <button type="button" class="btn-firecrawl btn-primary-fc" onclick="toggleReviewForm()">Add Review</button>
        }
        else
        {
             <button type="button" class="btn-firecrawl btn-primary-fc" onclick="window.location.href='@loginUrl'">Add Review</button>
        }
    </div>

    <!-- Add Review Form -->
    <div id="addReviewFormSection">
        <form id="addReviewForm" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="bookId" value="@(Model?.BookId)" />
            
            <div class="mb-4">
                <label class="form-label-fc">Your Rating</label>
                <select name="rating" class="form-control-fc" required>
                    <option value="5">5 - Excellent</option>
                    <option value="4">4 - Very Good</option>
                    <option value="3">3 - Good</option>
                    <option value="2">2 - Fair</option>
                    <option value="1">1 - Poor</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="form-label-fc">Share Your Thoughts</label>
                <textarea name="reviewContent" class="form-control-fc" rows="4" placeholder="What did you think about this book?..." required></textarea>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-firecrawl btn-ghost-fc" onclick="toggleReviewForm()">Cancel</button>
                <button type="submit" class="btn-firecrawl btn-primary-fc">Post Review</button>
            </div>
        </form>
    </div>

    <div id="reviewsList">
        @if (ViewBag.Reviews != null && ((IEnumerable<dynamic>)ViewBag.Reviews).Any())
        {
            @foreach (var review in ViewBag.Reviews)
            {
                <div class="review-card">
                    <div class="review-header">
                        <img src="@(ViewBag.UserImages != null && ViewBag.UserImages.ContainsKey(review.UserId) ? ViewBag.UserImages[review.UserId] : "https://randomuser.me/api/portraits/lego/1.jpg")" 
                             class="review-avatar" 
                             alt="User">
                        <div class="review-meta">
                            <div class="review-author">
                                @(ViewBag.UserDisplayNames != null && ViewBag.UserDisplayNames.ContainsKey(review.UserId) ? ViewBag.UserDisplayNames[review.UserId] : "Anonymous Reader")
                            </div>
                            <div class="review-verified">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="color: var(--fc-primary)">
                                    <path d="M20 6L9 17l-5-5"></path>
                                </svg>
                                Verified Reader
                            </div>
                        </div>
                    </div>

                    <div class="review-stars">
                        @for (int i = 0; i < (review.Rating ?? 5); i++)
                        {
                            <i class="fas fa-star"></i>
                        }
                        @for (int i = (review.Rating ?? 5); i < 5; i++)
                        {
                            <i class="far fa-star" style="opacity: 0.3;"></i>
                        }
                    </div>

                    <div class="review-content">@review.ReviewContent</div>

                    <div class="review-footer">
                        <span class="tag-pill">Insightful</span>
                        <span class="tag-pill">Must-read</span>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="empty-state">
                <p>No reviews yet. Be the first to share your thoughts!</p>
            </div>
        }
    </div>

    <script>
        function toggleReviewForm() {
            const formSection = document.getElementById('addReviewFormSection');
            if (!formSection) return;
            
            if (formSection.style.display === 'none' || getComputedStyle(formSection).display === 'none') {
                formSection.style.display = 'block';
                // Try to focus rating or textarea
                const input = formSection.querySelector('select');
                if(input) input.focus();
            } else {
                formSection.style.display = 'none';
            }
        }

        // Use a self-executing function to avoid global namespace pollution
        (function() {
            const form = document.getElementById('addReviewForm');
            if (!form) return;

            // Remove any existing listeners if this is a partial reload (though simple re-assign overwrites)
            form.onsubmit = async function (e) {
                e.preventDefault();
                console.log("Review Form submit triggered");

                const formData = new FormData(this);
                const bookId = formData.get('bookId');
                const rating = formData.get('rating');
                const reviewContent = formData.get('reviewContent');
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

                if (!bookId || !reviewContent) {
                    alert("Please fill in all fields.");
                    return false;
                }

                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerText;
                submitBtn.innerText = "Posting...";
                submitBtn.disabled = true;

                try {
                    const response = await fetch('/Review/AddReview', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'RequestVerificationToken': token,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin',
                        body: new URLSearchParams({
                            'bookId': bookId,
                            'rating': rating,
                            'reviewContent': reviewContent,
                            '__RequestVerificationToken': token
                        })
                    });

                    if (response.ok) {
                        const html = await response.text();
                        
                        // Check for login redirect in HTML response
                        if (html.includes('<html') || (html.includes('Login') && html.includes('form'))) {
                             alert('Session expired. Please login again.');
                             window.location.reload(); 
                             return;
                        }

                        // Update the reviews container
                        const mainContainer = document.querySelector('.firecrawl-reviews-wrapper');
                        if (mainContainer) {
                            // Ideally, we'd replace just the list, but the partial returns the whole partial
                            // So we might need to find the parent container in the main page
                            // For now, let's try to replace the outerHTML of the wrapper if possible, 
                            // or just the inner wrapper content if the server returns exactly this partial.
                            
                            // To be safe, let's look for the ID in the parent page that holds this partial.
                            // But since we are IN the partial, we can just replace the content of our own wrapper 
                            // if we can target it.
                            
                            // Simplest approach for compatibility with existing AJAX logic:
                            // The Controller likely acts as it did before.
                            // If the controller returns THIS partial view, we should replace the old one.
                            
                            // Let's assume the parent view has a container for this.
                            // If we can't find it, we reload.
                            
                           if (mainContainer.parentElement) {
                               mainContainer.parentElement.innerHTML = html;
                           } else {
                               window.location.reload();
                           }
                        } else {
                            window.location.reload();
                        }
                    } else if (response.status === 401) {
                        alert('Please login to post a review.');
                        window.location.href = '/Identity/Account/Login';
                    } else {
                        const text = await response.text();
                        alert('Error: ' + text);
                    }
                } catch (error) {
                    console.error("Error submitting review:", error);
                    alert("An error occurred. Please try again.");
                } finally {
                    submitBtn.innerText = originalText;
                    submitBtn.disabled = false;
                }
            };
        })();
    </script>
</div>
